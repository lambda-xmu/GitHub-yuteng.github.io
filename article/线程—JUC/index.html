<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          java.util.concurrent - äºè…¾ | Blog
        
    </title>

    <link rel="canonical" href="https://github-yuteng.github.io/article/çº¿ç¨‹â€”JUC/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/article_header/article_bg.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#çº¿ç¨‹" title="çº¿ç¨‹">çº¿ç¨‹</a>
                            
                        </div>
                        <h1>java.util.concurrent</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by äºè…¾ on
                            2019-05-02
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">æ‰€çˆ±éš”å±±æµ·</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">å…³äºæˆ‘</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="ä¸€-è¿›ç¨‹å’Œçº¿ç¨‹">ä¸€ã€è¿›ç¨‹å’Œçº¿ç¨‹</h2>
<p><strong>æ ¹æœ¬åŒºåˆ«ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯ CPU ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½</strong>ã€‚</p>
<ul>
<li><strong>ä¸€ä¸ªç¨‹åº(è¿›ç¨‹)åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªä»»åŠ¡ç§°ä¸ºä¸€ä¸ªçº¿ç¨‹ã€‚</strong></li>
<li><strong>è¿›ç¨‹æ˜¯çº¿ç¨‹çš„å®¹å™¨ï¼Œä¸å­˜åœ¨æ²¡æœ‰çº¿ç¨‹çš„è¿›ç¨‹çš„ã€‚</strong></li>
</ul>
<p><strong>åœ¨å¼€é”€æ–¹é¢ï¼š</strong></p>
<ul>
<li>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œç¨‹åºä¹‹é—´çš„åˆ‡æ¢ä¼šæœ‰è¾ƒå¤§çš„å¼€é”€ï¼›</li>
<li>çº¿ç¨‹å¯ä»¥çœ‹åšè½»é‡çº§çš„è¿›ç¨‹ï¼ŒåŒä¸€ç±»çº¿ç¨‹å…±äº«ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢çš„å¼€é”€å°ã€‚</li>
</ul>
<p><strong>æ‰€å¤„ç¯å¢ƒï¼š</strong></p>
<ul>
<li>åœ¨æ“ä½œç³»ç»Ÿä¸­èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰ï¼›</li>
<li>è€Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆé€šè¿‡CPUè°ƒåº¦ï¼Œåœ¨æ¯ä¸ªæ—¶é—´ç‰‡ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼‰</li>
</ul>
<p><strong>å†…å­˜åˆ†é…æ–¹é¢ï¼š</strong></p>
<ul>
<li><strong>è¿›ç¨‹ï¼š</strong> ç³»ç»Ÿåœ¨è¿è¡Œçš„æ—¶å€™ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜ç©ºé—´ï¼›</li>
<li><strong>çº¿ç¨‹ï¼š</strong> é™¤äº†CPUå¤–ï¼Œç³»ç»Ÿä¸ä¼šä¸ºçº¿ç¨‹åˆ†é…å†…å­˜ï¼ˆçº¿ç¨‹æ‰€ä½¿ç”¨çš„èµ„æºæ¥è‡ªå…¶æ‰€å±è¿›ç¨‹çš„èµ„æºï¼‰ï¼Œçº¿ç¨‹ç»„ä¹‹é—´åªèƒ½å…±äº«èµ„æºã€‚</li>
</ul>
<h3 id="11-å¤šè¿›ç¨‹ä¸å¤šçº¿ç¨‹åŒºåˆ«">1.1ã€å¤šè¿›ç¨‹ä¸å¤šçº¿ç¨‹åŒºåˆ«</h3>
<ul>
<li>æœ¬è´¨åŒºåˆ«åœ¨äºæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€å¥—å˜é‡ï¼Œè€Œçº¿ç¨‹åˆ™å…±äº«æ•°æ®ã€‚</li>
<li>å…±äº«å˜é‡ä½¿çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ¯”è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ›´æœ‰æ•ˆï¼Œæ›´å®¹æ˜“ã€‚</li>
<li>çº¿ç¨‹æ›´åŠ â€œè½»é‡çº§â€ï¼Œåˆ›å»ºã€æ’¤é”€ä¸€ä¸ªçº¿ç¨‹æ¯”å¯åŠ¨æ–°è¿›ç¨‹çš„å¼€é”€å°å¾—å¤šã€‚</li>
</ul>
<hr>
<h3 id="12-å®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹">1.2ã€å®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹</h3>
<ul>
<li>
<p><strong>ç¨‹åºè¿è¡Œå®Œæ¯•ï¼Œjvmä¼šç­‰å¾…éå®ˆæŠ¤çº¿ç¨‹å®Œæˆåå…³é—­ï¼Œä½†æ˜¯jvmä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹ã€‚</strong></p>
</li>
<li>
<p><strong>å®ˆæŠ¤çº¿ç¨‹æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯GCçº¿ç¨‹ã€‚</strong></p>
</li>
</ul>
<h4 id="å®ˆæŠ¤çº¿ç¨‹">å®ˆæŠ¤çº¿ç¨‹</h4>
<ul>
<li><strong>åƒåœ¾å›æ”¶çº¿ç¨‹ï¼šGCçº¿ç¨‹</strong></li>
<li><strong>å½“ä¸»çº¿ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶çº¿ç¨‹ä¸€èµ·è¿è¡Œã€‚å½“ä¸»çº¿ç¨‹é”€æ¯ï¼Œä¼šå’Œä¸»çº¿ç¨‹ä¸€èµ·é”€æ¯ã€‚</strong></li>
</ul>
<h4 id="éå®ˆæŠ¤çº¿ç¨‹ç”¨æˆ·çº¿ç¨‹">éå®ˆæŠ¤çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</h4>
<ul>
<li><strong>éå®ˆæŠ¤çº¿ç¨‹å³æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºçš„çº¿ç¨‹</strong>ã€‚</li>
<li><strong>å¦‚æœä¸»çº¿ç¨‹é”€æ¯ï¼Œç”¨æˆ·çº¿ç¨‹ç»§ç»­è¿è¡Œä¸”äº’ä¸å½±å“ã€‚</strong></li>
</ul>
<h4 id="åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹">åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹ ğŸ‘‡</h4>
<ul>
<li><strong>å¿…é¡»åœ¨ <code>t1.start()</code>ä¹‹å‰è®¾ç½®å®ˆæŠ¤çº¿ç¨‹ <code>t1.setDaemon(true);</code></strong></li>
<li><strong>ä¸èƒ½æŠŠæ­£åœ¨è¿è¡Œçš„å¸¸è§„çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹,å¦åˆ™æŠ¥IllegalThreadStateExceptionå¼‚å¸¸ã€‚</strong></li>
<li><strong>ä¸»çº¿ç¨‹ç»“æŸä¹‹åå¹¶æ²¡æœ‰åœ¨ç»§ç»­è¿è¡Œå®ˆæŠ¤çº¿ç¨‹ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿè·Ÿç€ç»“æŸï¼Œä¸€èµ·é”€æ¯åœæ­¢ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">/*Thread t1 = new Thread(new Runnable() &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                while (true) &#123;</span></span><br><span class="line"><span class="comment">                    try &#123;</span></span><br><span class="line"><span class="comment">                        Thread.sleep(1000);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">                        e.printStackTrace();</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    System.out.println("æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)");</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO æ ‡è¯†å½“å‰æ–¹æ³•ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œä¸€å®šè¦åœ¨å¯åŠ¨çº¿ç¨‹å‰è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">        t1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç›¸å½“ä¸ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"main:i:"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">main:i:<span class="number">0</span></span><br><span class="line">main:i:<span class="number">1</span></span><br><span class="line">main:i:<span class="number">2</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">3</span></span><br><span class="line">main:i:<span class="number">4</span></span><br><span class="line">main:i:<span class="number">5</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">6</span></span><br><span class="line">main:i:<span class="number">7</span></span><br><span class="line">main:i:<span class="number">8</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">9</span></span><br><span class="line">ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•...</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºéå®ˆæŠ¤çº¿ç¨‹">åˆ›å»ºéå®ˆæŠ¤çº¿ç¨‹ï¼šğŸ‘‡</h4>
<ul>
<li>
<p><strong>å¦‚æœä¸»çº¿ç¨‹é”€æ¯ï¼Œç”¨æˆ·çº¿ç¨‹ç»§ç»­è¿è¡Œä¸”äº’ä¸å½±å“ã€‚</strong></p>
</li>
<li>
<p><strong>å½“ä¸»çº¿ç¨‹é”€æ¯åœæ­¢ï¼Œéå®ˆæŠ¤çº¿ç¨‹ï¼ˆç”¨æˆ·çº¿ç¨‹ï¼‰å¹¶æ²¡æœ‰ç»“æŸï¼Œè€Œæ˜¯ä¸€ç›´åœ¨æ‰§è¡Œï¼Œä¸ä¸»çº¿ç¨‹äº’ä¸å½±å“ã€‚</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotDaemonThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">/* Thread t1 = new Thread(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                while (true) &#123;</span></span><br><span class="line"><span class="comment">                    try &#123;</span></span><br><span class="line"><span class="comment">                        Thread.sleep(1000);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">                        e.printStackTrace();</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    System.out.println("æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)");</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// TODO å¯åŠ¨çº¿ç¨‹ æ²¡æœ‰å¼€å¯å®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç›¸å½“ä¸ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">300</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"main:i:"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">main:i:<span class="number">0</span></span><br><span class="line">main:i:<span class="number">1</span></span><br><span class="line">main:i:<span class="number">2</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">3</span></span><br><span class="line">main:i:<span class="number">4</span></span><br><span class="line">main:i:<span class="number">5</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">6</span></span><br><span class="line">main:i:<span class="number">7</span></span><br><span class="line">main:i:<span class="number">8</span></span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">main:i:<span class="number">9</span></span><br><span class="line">ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•...</span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">æˆ‘æ˜¯å­çº¿ç¨‹(ç”¨æˆ·çº¿ç¨‹)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="äºŒ-volatile">äºŒã€volatile</h2>
<p><strong>volatile å…³é”®å­—ï¼š</strong></p>
<ul>
<li><strong>æ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ã€‚å½“å¤šä¸ªçº¿ç¨‹è¿›è¡Œæ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œå¯ä»¥ä¿è¯å†…å­˜ä¸­çš„æ•°æ®å¯è§ã€‚æä¾›ä¸€ä¸ªå…é”æœºåˆ¶ï¼Œç›¸è¾ƒäº synchronized æ˜¯ä¸€ç§è¾ƒä¸ºè½»é‡çº§çš„åŒæ­¥ç­–ç•¥ã€‚</strong></li>
</ul>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>
<p><strong>volatile ä¿è¯å†…å­˜å¯è§æ€§</strong>ï¼›</p>
</li>
<li>
<p><strong>volatile ä¸èƒ½ä¿è¯å˜é‡çš„â€œåŸå­æ€§â€ï¼›</strong> ä¸å¯åˆ†å‰²ï¼Œå®Œæ•´æ€§ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å¯ä»¥è¢«åŠ å¡ã€‚</p>
</li>
<li>
<p><strong>volatile ä¸å…·å¤‡â€œäº’æ–¥æ€§â€ï¼›</strong>(äº’æ–¥æ€§ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œå¦å¤–çº¿ç¨‹åˆ™å¿…é¡»ç­‰å¾…)</p>
</li>
<li>
<p><strong>ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚</strong></p>
</li>
</ul>
<img src="https://i.loli.net/2019/07/19/5d3132852c9c330873.png" alt="1.png" title="1.png">
<h3 id="21-æµ‹è¯•-volatile-å†…å­˜å¯è§æ€§">2.1ã€æµ‹è¯• volatile å†…å­˜å¯è§æ€§</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ThreadDemo td = <span class="keyword">new</span> ThreadDemo();</span><br><span class="line">		<span class="keyword">new</span> Thread(td).start();</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (td.isFlag()) &#123;</span><br><span class="line">				System.out.println(<span class="string">"End"</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// voatile æ¯”é”æ•ˆç‡è¦é«˜</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">200</span>);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		flag = <span class="keyword">true</span>;</span><br><span class="line">		System.out.println(<span class="string">"flag="</span> + isFlag());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlag</span><span class="params">(<span class="keyword">boolean</span> flag)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.flag = flag;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">flag=<span class="keyword">true</span></span><br><span class="line">End</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="22-æµ‹è¯•-volatile-åŸå­æ€§">2.2ã€æµ‹è¯• volatile åŸå­æ€§</h3>
<p><strong>i++ çš„åŸå­æ€§é—®é¢˜ï¼š</strong></p>
<ul>
<li><strong>i++ çš„æ“ä½œå®é™…ä¸Šåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤â€œè¯»-æ”¹-å†™â€œ å­—èŠ‚ç å¦‚ä¸‹ï¼š</strong>
<ul>
<li><strong>aload_0</strong></li>
<li><strong>dup</strong></li>
<li><strong>getfield</strong></li>
<li><strong>iconst_1</strong></li>
<li><strong>iadd</strong></li>
<li><strong>putfield</strong></li>
</ul>
</li>
</ul>
<p><strong>åœ¨ä¸­é—´æŸä¸€æ­¥å¦‚æœCPUåˆ‡æ¢è°ƒåº¦ï¼Œåˆ™æ— æ³•ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ã€‚</strong></p>
<p><strong>åŸå­å˜é‡ï¼šåœ¨ java.util.concurrent.atomic åŒ…ä¸‹æä¾›äº†ä¸€äº›åŸå­å˜é‡ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">numTo60</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">60</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPulsPuls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyAtomicInteger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        atomicInteger.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        VolatileKeyWord();</span><br><span class="line">        System.out.println(<span class="string">"-----------"</span>);</span><br><span class="line">        AtomicIntegerDemo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AtomicIntegerDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyData myData = <span class="keyword">new</span> MyData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                    myData.addPulsPuls();</span><br><span class="line">                    myData.MyAtomicInteger();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, String.valueOf(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å½“ä¸Šé¢ 20ä¸ªçº¿ç¨‹è¿è¡Œå®Œæ¯•åï¼Œç”¨ Mainçº¿ç¨‹çœ‹æœ€åç»“æœæ˜¯å¤šå°‘</span></span><br><span class="line">        <span class="comment">// main &amp; GC</span></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Finally num :"</span> + myData.num);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Finally num :"</span> + myData.atomicInteger);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * volatile int num = 0;</span></span><br><span class="line"><span class="comment">     * 1ã€è¯æ˜ Volatile å†…å­˜å¯è§æ€§</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">VolatileKeyWord</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MyData myData = <span class="keyword">new</span> MyData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Enter"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            myData.numTo60();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Updata num"</span> + myData.num);</span><br><span class="line">        &#125;, <span class="string">"Thread-Son"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (myData.num == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"End:"</span> + myData.num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="23-cas">2.3ã€CAS</h3>
<img src="https://i.loli.net/2019/07/19/5d31582d1577279493.png" alt="B`4}R)9N%M5$KV]$7RPQ$_M.png" title="B`4}R)9N%M5$KV]$7RPQ$_M.png">
<ul>
<li><strong>CASï¼ˆCompare-And-Swapï¼‰ ç®—æ³•ä¿è¯æ•°æ®å˜é‡çš„åŸå­æ€§</strong>ã€‚</li>
<li><strong>CAS ç®—æ³•æ˜¯ç¡¬ä»¶å¯¹äºå¹¶å‘æ“ä½œçš„æ”¯æŒ  æ•ˆç‡æ¯”åŒæ­¥é”é«˜</strong> ã€‚</li>
<li><strong>CAS åŒ…å«äº†ä¸‰ä¸ªæ“ä½œæ•°ï¼š</strong>
<ul>
<li><strong>â‘ å†…å­˜å€¼  V</strong></li>
<li><strong>â‘¡é¢„ä¼°å€¼  A</strong></li>
<li><strong>â‘¢æ›´æ–°å€¼  B</strong></li>
<li><strong>å½“ä¸”ä»…å½“ V == A æ—¶ï¼Œâ€”&gt; V = B;  B èµ‹å€¼ç»™ V å¦åˆ™ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚</strong></li>
</ul>
</li>
<li><strong>å®ƒçš„åŠŸèƒ½æ˜¯åˆ¤æ–­å†…å­˜æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ”¹ä¸ºæ–°å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­çš„ã€‚</strong></li>
</ul>
<p><strong>CAS</strong> å¹¶å‘åŸè¯­ä½“ç°åœ¨ JAVA è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚è°ƒç”¨ UnSafe ç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVM ä¼šå¸®æˆ‘ä»¬å®ç°å‡ºCASæ±‡ç¼–æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œã€‚ç”±äºCASæ˜¯ä¸€ ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»Ÿç”¨è¯­èŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œ<strong>å¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´CASæ˜¯ä¸€æ¡CPUçš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong>ã€‚</p>
<hr>
<h4 id="unsafe-ç±»">Unsafe ç±»</h4>
<p>Unsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°(native) æ–¹æ³•æ¥è®¿é—®ï¼ŒUnsafeç›¸å½“äºä¸€ä¸ªåé—¨ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®ã€‚Unsafe ç±»å­˜åœ¨äº <code>rt.jar sun.misc</code> åŒ…ä¸­ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œå¯ä»¥åƒCçš„æŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ï¼Œå› ä¸ºJavaä¸­ CAS æ“ä½œçš„æ‰§è¡Œä¾èµ–äº Unsafe ç±»çš„æ–¹æ³•ã€‚</p>
<ul>
<li><strong>æ³¨ï¼šUnsafeç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯nativeä¿®é¥°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Unsafeç±»ä¸­çš„æ–¹æ³•éƒ½ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚èµ„æºæ‰§è¡Œç›¸åº”ä»»åŠ¡</strong></li>
</ul>
<hr>
<h4 id="cas-çš„ç¼ºç‚¹">CAS çš„ç¼ºç‚¹</h4>
<ul>
<li>å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¤§ã€‚å¦‚æœCASå¤±è´¥ï¼Œä¼šä¸€ç›´è¿›è¡Œå°è¯•ã€‚å¦‚æœCASé•¿æ—¶é—´ä¸€ç›´ä¸æˆåŠŸï¼Œå¯èƒ½ä¼šç»™CPUå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚</li>
<li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼›å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦é”æ¥ä¿è¯åŸå­æ€§ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Atomically increments by one the current value.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">* this å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment">* valueOffset å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var1 AtomicIntegerå¯¹è±¡æœ¬èº«</span></span><br><span class="line"><span class="comment">// var2 è¯¥å¯¹è±¡å€¼çš„å¼•ç”¨åœ°å€</span></span><br><span class="line"><span class="comment">// var4 éœ€è¦å˜åŠ¨çš„å€¼ -&gt; 1</span></span><br><span class="line"><span class="comment">// var5 é€šè¿‡var1ã€var2æ‰¾å‡ºä¸»å†…å­˜ä¸­çœŸå®çš„å€¼</span></span><br><span class="line"><span class="comment">// ç”¨è¯¥å¯¹è±¡å½“å‰çš„å€¼ä¸var5æ¯”è¾ƒï¼š</span></span><br><span class="line"><span class="comment">// ç›¸åŒï¼Œæ›´æ–°var5+var4å¹¶è¿”å›true</span></span><br><span class="line"><span class="comment">// ä¸åŒï¼Œç»§ç»­å–å€¼ç„¶åå†æ¯”è¾ƒ,ç›´åˆ°æ›´æ–°å®Œæˆ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="aba-é—®é¢˜">ABA é—®é¢˜ ğŸ‘‡</h4>
<p>CASç®—æ³•å®ç°ä¸€ä¸ªé‡è¦å‰æéœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®å¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶é—´å·®ç±»ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–ã€‚</p>
<ul>
<li>æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vä¸­å–å‡ºAï¼Œè¿™æ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†B,:ç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä»ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸã€‚<strong>å°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CASDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicReference&lt;Integer&gt; atomicReference = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>);</span><br><span class="line">            atomicReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æš‚åœ1ç§’é’Ÿt2çº¿ç¨‹ï¼Œä¿è¯ä¸Šé¢çš„t1çº¿ç¨‹å®Œæˆäº†ä¸€æ¬¡ABAæ“ä½œ</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"-&gt;"</span> + atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">200</span>) + <span class="string">"\t"</span> + atomicReference.get());</span><br><span class="line">        &#125;, <span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">è¾“å‡º <span class="keyword">true</span>	<span class="number">200</span></span><br></pre></td></tr></table></figure>
<h4 id="è§£å†³-aba-åŸå­å¼•ç”¨">è§£å†³ ABA åŸå­å¼•ç”¨</h4>
<ul>
<li><strong>AtomicStampedReference</strong></li>
<li><strong>AtomicReference</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CASTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedReference = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"------ABAé—®é¢˜çš„è§£å†³--------"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// åˆå§‹ç‰ˆæœ¬å·</span></span><br><span class="line">            <span class="keyword">int</span> stamp = atomicStampedReference.getStamp();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tç¬¬ 1 æ¬¡ç‰ˆæœ¬å·"</span> + stamp);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æš‚åœ1ç§’é’Ÿt3çº¿ç¨‹</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            atomicStampedReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>,</span><br><span class="line">                    atomicStampedReference.getStamp(), atomicStampedReference.getStamp() + <span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tç¬¬ 2 æ¬¡ç‰ˆæœ¬å·"</span> + atomicStampedReference.getStamp());</span><br><span class="line"></span><br><span class="line">            atomicStampedReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>,</span><br><span class="line">                    atomicStampedReference.getStamp(), atomicStampedReference.getStamp() + <span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tç¬¬ 3 æ¬¡ç‰ˆæœ¬å·"</span> + atomicStampedReference.getStamp());</span><br><span class="line">        &#125;, <span class="string">"t3"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> stamp = atomicStampedReference.getStamp();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tç¬¬ 1 æ¬¡ç‰ˆæœ¬å·"</span> + stamp);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æš‚åœ3ç§’é’Ÿt4çº¿ç¨‹ï¼Œä¿è¯ä¸Šé¢çš„t3çº¿ç¨‹å®Œæˆäº†ä¸€æ¬¡ABAæ“ä½œ</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¿™é‡Œå¿…é¡»é‡æ–°è·å–ç‰ˆæœ¬å· æ‰å¯ä»¥å®Œæˆä¿®æ”¹</span></span><br><span class="line"><span class="comment">//            int newStamp = atomicStampedReference.getStamp();</span></span><br><span class="line">            <span class="keyword">boolean</span> result = atomicStampedReference.compareAndSet(<span class="number">100</span>, <span class="number">200</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tä¿®æ”¹æˆåŠŸå¦ï¼š"</span> + result + <span class="string">"\tå½“å‰æœ€æ–°å®é™…ç‰ˆæœ¬å·:"</span> + atomicStampedReference.getStamp());</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tå½“å‰å®é™…æœ€æ–°å€¼ï¼š"</span> + atomicStampedReference.getReference());</span><br><span class="line">        &#125;, <span class="string">"t4"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">------ABAé—®é¢˜çš„è§£å†³--------</span><br><span class="line">t3	ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·<span class="number">1</span></span><br><span class="line">t4	ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·<span class="number">1</span></span><br><span class="line">t3	ç¬¬äºŒæ¬¡ç‰ˆæœ¬å·<span class="number">2</span></span><br><span class="line">t3	ç¬¬ä¸‰æ¬¡ç‰ˆæœ¬å·<span class="number">3</span></span><br><span class="line">t4	ä¿®æ”¹æˆåŠŸå¦ï¼š<span class="keyword">false</span>	å½“å‰æœ€æ–°å®é™…ç‰ˆæœ¬å·:<span class="number">3</span></span><br><span class="line">t4	å½“å‰å®é™…æœ€æ–°å€¼ï¼š<span class="number">100</span></span><br></pre></td></tr></table></figure>
<h4 id="æ¨¡æ‹Ÿ-cas-ç®—æ³•">æ¨¡æ‹Ÿ CAS ç®—æ³•</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCompareAndSwap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> CompareAndSwap cas = <span class="keyword">new</span> CompareAndSwap();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">int</span> expectedValue = cas.get();</span><br><span class="line">					<span class="keyword">boolean</span> b = cas.compareAndSet(expectedValue, (<span class="keyword">int</span>)(Math.random() * <span class="number">101</span>));</span><br><span class="line">					System.out.println(b);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompareAndSwap</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">	<span class="comment">//è·å–å†…å­˜å€¼</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æ¯”è¾ƒ</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">compareAndSwap</span><span class="params">(<span class="keyword">int</span> expectedValue, <span class="keyword">int</span> newValue)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> oldValue = value;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(oldValue == expectedValue)&#123;</span><br><span class="line">			<span class="keyword">this</span>.value = newValue;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> oldValue;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//è®¾ç½®</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expectedValue, <span class="keyword">int</span> newValue)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> expectedValue == compareAndSwap(expectedValue, newValue);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ä¸ºä»€ä¹ˆç”¨-cas-ä¸ç”¨-synchronized">ä¸ºä»€ä¹ˆç”¨ CAS ä¸ç”¨ Synchronized</h4>
<p>åœ¨Javaå¹¶å‘ä¸­ï¼Œæˆ‘ä»¬æœ€åˆæ¥è§¦çš„åº”è¯¥å°±æ˜¯<code>synchronized</code>å…³é”®å­—äº†ï¼Œä½†æ˜¯<code>synchronized</code>å±äºé‡é‡çº§é”ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå¼•èµ·æ€§èƒ½é—®é¢˜ï¼Œvolatileä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯volatileä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œåªèƒ½åœ¨æŸäº›åœºåˆä¸‹ä½¿ç”¨ã€‚åƒ<code>synchronized</code>è¿™ç§ç‹¬å é”å±äº<strong>æ‚²è§‚é”</strong>ï¼Œå®ƒæ˜¯åœ¨å‡è®¾ä¸€å®šä¼šå‘ç”Ÿå†²çªçš„ï¼Œé‚£ä¹ˆåŠ é”æ°å¥½æœ‰ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰<strong>ä¹è§‚é”</strong>ï¼Œä¹è§‚é”çš„å«ä¹‰å°±æ˜¯å‡è®¾æ²¡æœ‰å‘ç”Ÿå†²çªï¼Œé‚£ä¹ˆæˆ‘æ­£å¥½å¯ä»¥è¿›è¡ŒæŸé¡¹æ“ä½œï¼Œå¦‚æœè¦æ˜¯å‘ç”Ÿå†²çªå‘¢ï¼Œé‚£æˆ‘å°±é‡è¯•ç›´åˆ°æˆåŠŸï¼Œä¹è§‚é”æœ€å¸¸è§çš„å°±æ˜¯<code>CAS</code>ã€‚</p>
<hr>
<h3 id="24-ç¦æ­¢æŒ‡ä»¤é‡æ’">2.4ã€ç¦æ­¢æŒ‡ä»¤é‡æ’</h3>
<p><strong>æŒ‡ä»¤é‡æ’åº :</strong> å¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚</p>
<p><strong>JVMåº•å±‚ä¼˜åŒ–ï¼ŒæŒ‡ä»¤é‡æ’åº(ä¹±åºæ‰§è¡Œï¼Œå¢åŠ æ•ˆç‡)ï¼Œä½¿ç”¨volatileä¿®é¥°åå°±ä¸èƒ½é‡æ’åºäº†ã€‚</strong></p>
<ul>
<li><strong>æœ‰volatileä¿®é¥°çš„å˜é‡ï¼Œèµ‹å€¼åå¤šæ‰§è¡Œäº†ä¸€ä¸ªâ€œload addl $0x0, (%esp)â€æ“ä½œï¼Œè¿™ä¸ªæ“ä½œç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼ˆæŒ‡ä»¤é‡æ’åºæ—¶ä¸èƒ½æŠŠåé¢çš„æŒ‡ä»¤é‡æ’åºåˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼‰ï¼Œåªæœ‰ä¸€ä¸ªCPUè®¿é—®å†…å­˜æ—¶ï¼Œå¹¶ä¸éœ€è¦å†…å­˜å±éšœï¼›ï¼ˆä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼šæ˜¯æŒ‡CPUé‡‡ç”¨äº†å…è®¸å°†å¤šæ¡æŒ‡ä»¤ä¸æŒ‰ç¨‹åºè§„å®šçš„é¡ºåºåˆ†å¼€å‘é€ç»™å„ç›¸åº”ç”µè·¯å•å…ƒå¤„ç†ï¼‰ã€‚</strong></li>
</ul>
<hr>
<h3 id="25-volatile-ä½¿ç”¨åœºæ™¯">2.5ã€volatile ä½¿ç”¨åœºæ™¯</h3>
<h4 id="å•ä¾‹è®¾è®¡æ¨¡å¼-dclåŒæ£€æŸ¥é”æœºåˆ¶">å•ä¾‹è®¾è®¡æ¨¡å¼ DCLåŒæ£€æŸ¥é”æœºåˆ¶</h4>
<ul>
<li>å› ä¸ºæœ‰æŒ‡ä»¤é‡æ’åºçš„å­˜åœ¨ï¼Œ DCLä¸ä¸€å®šå®‰å…¨ã€‚ä½†æ˜¯åŠ äº† volatile å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†è‡ªèº«å®ä¾‹åŒ–å¯¹è±¡è®¾ç½®ä¸ºä¸€ä¸ªå±æ€§ï¼Œå¹¶ç”¨staticä¿®é¥°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton instance;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•ç§æœ‰åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•è¿”å›è¯¥å®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥instanceæ˜¯å¦è¢«å®ä¾‹åŒ–å‡ºæ¥ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥ifå—</span></span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// æŸä¸ªçº¿ç¨‹å–å¾—äº†ç±»é”ï¼Œå®ä¾‹åŒ–å¯¹è±¡å‰ç¬¬äºŒæ¬¡æ£€æŸ¥instanceæ˜¯å¦å·²ç»è¢«å®ä¾‹åŒ–å‡ºæ¥</span></span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œæ‰æœ€ç»ˆå®ä¾‹å‡ºå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton();<span class="comment">//è¿™ä¸€è¡Œä»£ç å¯ä»¥åˆ†ä¸º ä¸‰æ­¥ã€‚æœ‰å¯èƒ½æŒ‡ä»¤é‡æ’åº</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ä¸‰-concurrenthashmap">ä¸‰ã€ConcurrentHashMap</h2>
<p><strong>if (<code>key == null || value == null</code>) throw new <code>NullPointerException();</code></strong></p>
<ul>
<li><strong>key-valueéƒ½ä¸å¯ä¸ºç©ºï¼</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br></pre></td></tr></table></figure>
<p><strong>ConcurrentHashMap å¯ä»¥æ”¯æŒå¹¶å‘çš„è¯»å†™</strong>ã€‚</p>
<img src="https://i.loli.net/2019/07/17/5d2ece546df0066415.png" alt="1.png" title="1.png">
<p><strong>HashMapï¼šéçº¿ç¨‹å®‰å…¨</strong>ï¼Œå³ä»»ä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™HashMapï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚</p>
<ul>
<li>HashMap åšput æ“ä½œçš„æ—¶å€™ï¼Œå‡å¦‚Açº¿ç¨‹å’ŒBçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ä¸ªæ•°ç»„ä½ç½®è°ƒç”¨addEntryï¼Œä¸¤ä¸ªçº¿ç¨‹ä¼šåŒæ—¶å¾—åˆ°ç°åœ¨çš„å¤´ç»“ç‚¹ï¼Œç„¶åAå†™å…¥æ–°çš„å¤´ç»“ç‚¹ä¹‹åï¼ŒBä¹Ÿå†™å…¥æ–°çš„å¤´ç»“ç‚¹ï¼Œé‚£Bçš„å†™å…¥æ“ä½œå°±ä¼šè¦†ç›–Açš„å†™å…¥æ“ä½œé€ æˆAçš„å†™å…¥æ“ä½œä¸¢å¤±ã€‚åŒç†ï¼Œå½“å¤šçº¿ç¨‹å¯¹åŒä¸€æ•°ç»„ä½ç½®è¿›è¡Œremoveæ“ä½œæ—¶ä¹Ÿä¼šäº§ç”Ÿè¦†ç›–ã€‚å› æ­¤å¦‚æœä¸è¿›è¡Œé¢å¤–çš„å¤–åŒæ­¥æ“ä½œï¼ŒHashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚æ ·å¿…ç„¶å¯¼è‡´æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”ç«äº‰è¶Šæ¿€çƒˆï¼Œæ•ˆç‡è¶Šä½ä¸‹ã€‚ä¸¥é‡æƒ…å†µï¼Œ<strong>ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨HashMapè¿›è¡Œputæ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯(æ¯”å¦‚putçš„ä¸¤ä¸ªå¯¹è±¡ å¼•èµ·æ‰©å®¹ï¼Œå¯èƒ½å‡ºç°åŒæ—¶åœ¨åŒä¸€æ•°ç»„ä¸‹ç”¨é“¾è¡¨è¡¨ç¤ºï¼Œç»“æœåœ¨getæ—¶ä¼šå‡ºç°æ­»å¾ªç¯)ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%</strong>ã€‚</li>
</ul>
<p><strong>HashTableï¼šé—ç•™ç±»ï¼Œçº¿ç¨‹å®‰å…¨ã€‚</strong> å¾ˆå¤šæ˜ å°„çš„å¸¸ç”¨åŠŸèƒ½ä¸HashMapç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ‰¿è‡ªDictionaryç±»ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»»ä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥Hashtableã€‚</p>
<ul>
<li>HashTable åªæœ‰ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—® HashTable çš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œä¼šå°†æ•´å¼  table é”ä½ï¼Œå½“å…¶ä»–çº¿ç¨‹ä¹Ÿæƒ³è®¿é—® HashTable åŒæ­¥æ–¹æ³•æ—¶ï¼Œå°±ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹åŒæ­¥æ–¹æ³•çš„å ç”¨ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œç¡®ä¿çº¿ç¨‹çš„å®‰å…¨æ€§ã€‚ä½†æ˜¯ HashTable å¯¹ getï¼Œputï¼Œremove æ–¹æ³•éƒ½ä½¿ç”¨äº†åŒæ­¥æ“ä½œï¼Œè¿™å°±é€ æˆå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½åªæƒ³ä½¿ç”¨get æ–¹æ³•å»è¯»å–æ•°æ®æ—¶ï¼Œå› ä¸ºä¸€ä¸ªçº¿ç¨‹å…ˆåˆ°è¿›è¡Œäº†é”æ“ä½œï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±ä¸å¾—ä¸ç­‰å¾…ï¼Œè¿™æ ·å¿…ç„¶å¯¼è‡´æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”ç«äº‰è¶Šæ¿€çƒˆï¼Œæ•ˆç‡è¶Šä½ä¸‹ã€‚</li>
</ul>
<h3 id="31-jdk-17-concurrenthashmap">3.1ã€JDK 1.7 ConcurrentHashMap</h3>
<p><strong>ReentrantLock + Segment + HashEntry</strong></p>
<p><strong>JDK1.7 ä¹‹å‰çš„ ConcurrentHashMap <code>æ•°ç»„+é“¾è¡¨</code> ä½¿ç”¨åˆ†æ®µé”æœºåˆ¶å®ç°ã€‚(JDK 1.5â€”JDK1.7)</strong></p>
<ul>
<li>ConcurrentHashMap åœ¨å¯¹è±¡ä¸­ä¿å­˜äº†ä¸€ä¸ª Segment æ•°ç»„ï¼Œå³å°†æ•´ä¸ªHashè¡¨åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†æ®µï¼›è€Œæ¯ä¸ªSegment å…ƒç´ ï¼Œå³æ¯ä¸ªåˆ†æ®µåˆ™ç±»ä¼¼äºä¸€ä¸ªHashtableï¼›è¿™æ ·ï¼Œåœ¨æ‰§è¡Œputæ“ä½œæ—¶é¦–å…ˆæ ¹æ®hashç®—æ³•å®šä½åˆ°å…ƒç´ å±äºå“ªä¸ª Segmentï¼Œç„¶åå¯¹è¯¥SegmentåŠ é”å³å¯ã€‚</li>
</ul>
<hr>
<h3 id="32-jdk-18-concurrenthashmap">3.2ã€JDK 1.8 ConcurrentHashMap</h3>
<p><strong>Synchronized + CAS + HashEntry + Red-Black Tree</strong></p>
<p><strong>JDK 1.8 å·²ç»æŠ›å¼ƒäº†Segment çš„æ¦‚å¿µï¼Œè™½ç„¶æºç é‡Œé¢è¿˜ä¿ç•™äº†ï¼Œä¹Ÿåªæ˜¯ä¸ºäº†å…¼å®¹æ€§çš„è€ƒè™‘ã€‚</strong><br>
<strong>JDK1.8 åˆ™ä½¿ç”¨<code>æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘æ•°æ®ç»“æ„ã€å¹¶å‘æ§åˆ¶ä½¿ç”¨Synchronizedå’ŒCASåŸå­æ“ä½œ</code>å®ç°ConcurrentHashMap</strong></p>
<h4 id="concurrenthashmap-çš„putæ–¹æ³•å®ç°">ConcurrentHashMap çš„putæ–¹æ³•å®ç°</h4>
<p><strong>å®ç°æ€è·¯ï¼š</strong></p>
<ul>
<li><strong>1.å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±å…ˆè°ƒç”¨ initTable() æ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹ã€‚</strong></li>
<li><strong>2.å¦‚æœæ²¡æœ‰hashå†²çªå°±ç›´æ¥CASæ’å…¥ã€‚</strong></li>
<li><strong>3.å¦‚æœè¿˜åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œå°±å…ˆè¿›è¡Œæ‰©å®¹ã€‚</strong></li>
<li><strong>4.å¦‚æœå­˜åœ¨hashå†²çªï¼Œå°±åŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯é“¾è¡¨å½¢å¼å°±ç›´æ¥éå†åˆ°å°¾ç«¯æ’å…¥ï¼Œä¸€ç§æ˜¯çº¢é»‘æ ‘å°±æŒ‰ç…§çº¢é»‘æ ‘ç»“æ„æ’å…¥</strong>ã€‚</li>
<li><strong>5.æœ€åä¸€ä¸ªå¦‚æœè¯¥é“¾è¡¨çš„æ•°é‡å¤§äºé˜ˆå€¼8ï¼Œå°±è¦å…ˆè½¬æ¢æˆé»‘çº¢æ ‘çš„ç»“æ„ï¼Œbreakå†ä¸€æ¬¡è¿›å…¥å¾ªç¯</strong>ã€‚</li>
<li><strong>6.å¦‚æœæ·»åŠ æˆåŠŸå°±è°ƒç”¨ addCount() æ–¹æ³•ç»Ÿè®¡sizeï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</strong>ã€‚</li>
</ul>
<hr>
<h4 id="concurrenthashmap-çš„getæ–¹æ³•å®ç°">ConcurrentHashMap çš„getæ–¹æ³•å®ç°</h4>
<p><strong>å®ç°æ€è·¯ï¼š</strong></p>
<ul>
<li><strong>1.è®¡ç®—hashå€¼ï¼Œå®šä½åˆ°è¯¥tableç´¢å¼•ä½ç½®ï¼Œå¦‚æœæ˜¯é¦–èŠ‚ç‚¹ç¬¦åˆå°±è¿”å›</strong>ã€‚</li>
<li><strong>2.å¦‚æœé‡åˆ°æ‰©å®¹çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ ‡å¿—æ­£åœ¨æ‰©å®¹èŠ‚ç‚¹ForwardingNodeçš„findæ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å›</strong>ã€‚</li>
<li><strong>3.ä»¥ä¸Šéƒ½ä¸ç¬¦åˆçš„è¯ï¼Œå°±å¾€ä¸‹éå†èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å›ï¼Œå¦åˆ™æœ€åå°±è¿”å›null</strong> ã€‚</li>
</ul>
<hr>
<h3 id="33-jdk18-synchronizedä»£æ›¿reentrantlock">3.3ã€JDK1.8 Synchronizedä»£æ›¿ReentrantLock</h3>
<p><strong>JDK1.8ä¸ºä»€ä¹ˆä½¿ç”¨å†…ç½®é”synchronizedæ¥ä»£æ›¿é‡å…¥é”ReentrantLockï¼š</strong></p>
<ol>
<li>å› ä¸ºç²’åº¦é™ä½äº†ï¼Œåœ¨ç›¸å¯¹è€Œè¨€çš„ä½ç²’åº¦åŠ é”æ–¹å¼ï¼Œsynchronized å¹¶ä¸æ¯” ReentrantLock å·®ï¼Œåœ¨ç²—ç²’åº¦åŠ é”ä¸­ReentrantLock å¯èƒ½é€šè¿‡ Condition æ¥æ§åˆ¶å„ä¸ªä½ç²’åº¦çš„è¾¹ç•Œï¼Œæ›´åŠ çš„çµæ´»ï¼Œè€Œåœ¨ä½ç²’åº¦ä¸­ï¼ŒCondition çš„ä¼˜åŠ¿å°±æ²¡æœ‰äº†ï¼›</li>
<li>JVMçš„å¼€å‘å›¢é˜Ÿä»æ¥éƒ½æ²¡æœ‰æ”¾å¼ƒ synchronizedï¼Œè€Œä¸”åŸºäº JVM çš„ synchronized ä¼˜åŒ–ç©ºé—´æ›´å¤§ï¼Œä½¿ç”¨å†…åµŒçš„å…³é”®å­—æ¯”ä½¿ç”¨APIæ›´åŠ è‡ªç„¶ï¼›</li>
<li>åœ¨å¤§é‡çš„æ•°æ®æ“ä½œä¸‹ï¼Œå¯¹äºJVMçš„å†…å­˜å‹åŠ›ï¼ŒåŸºäº API çš„ ReentrantLock ä¼šå¼€é”€æ›´å¤šçš„å†…å­˜ï¼Œè™½ç„¶ä¸æ˜¯ç“¶é¢ˆï¼Œä½†æ˜¯ä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©ä¾æ®ã€‚</li>
</ol>
<hr>
<h2 id="å››-unsafecollection">å››ã€UnSafeCollection</h2>
<h3 id="41-unsafelist">4.1ã€UnSafeList</h3>
<h4 id="arraylist-æ•…éšœç°è±¡">ArrayList æ•…éšœç°è±¡ğŸ‘‡</h4>
<ul>
<li><strong>java.util.ConcurrentModificationException</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnSafeList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">30</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                list.add(UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">8</span>));</span><br><span class="line">                System.out.println(list.toString());</span><br><span class="line">            &#125;, String.valueOf(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="arraylist-æ•…éšœå¯¼è‡´åŸå› ">ArrayList æ•…éšœå¯¼è‡´åŸå› ğŸ‘‡</h4>
<ul>
<li><strong>å¹¶å‘äº‰æŠ¢ä¿®æ”¹å¯¼è‡´ã€‚</strong></li>
</ul>
<h4 id="arraylist-æ•…éšœè§£å†³æ–¹æ¡ˆ">ArrayList æ•…éšœè§£å†³æ–¹æ¡ˆğŸ‘‡</h4>
<ul>
<li><strong>List&lt;String&gt; list = new Vector();//å·²ç»åºŸå¼ƒ</strong></li>
<li><strong>List&lt;String&gt; list = Collections.synchronizedList(new ArrayList&lt;&gt;());</strong></li>
<li><strong><code>List&lt;String\&gt; list = new CopyOnWriteArrayList&lt;&gt;();</code>add æºç å¦‚ä¸‹ï¼šğŸ‘‡</strong></li>
</ul>
<p><strong>CopyOnWriteArrayList å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨ Object[ ] æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨ Object[ ] è¿›è¡Œ Copyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ Object[ ] newElements, ç„¶åæ–°çš„å®¹å™¨ Object[ ] newElements é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´ ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ setArray(newElements);</strong></p>
<p><strong>è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å¯¹ CopyOnWriteArrayList å®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯»ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥ CopyOnWriteArrayList å®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Appends the specified element to the end of this list.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> e element to be appended to this list</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; (as specified by &#123;<span class="doctag">@link</span> Collection#add&#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="copyonwritearraylist">CopyOnWriteArrayList</h4>
<p><strong>â€œå†™å…¥å¹¶å¤åˆ¶â€æ¯æ¬¡å†™å…¥å¤åˆ¶æ–°è¡¨</strong></p>
<ul>
<li><strong>CopyOnWriteArrayList åªæ˜¯åœ¨å¢åˆ æ”¹ä¸ŠåŠ é”ï¼Œä½†æ˜¯è¯»ä¸åŠ é”ï¼Œåœ¨è¯»æ–¹é¢çš„æ€§èƒ½å°±å¥½äºVectorï¼ŒCopyOnWriteArrayList æ”¯æŒè¯»å¤šå†™å°‘çš„å¹¶å‘æƒ…å†µã€‚é€‚åˆè¿­ä»£</strong></li>
</ul>
<hr>
<p><strong>æ³¨æ„ï¼šæ·»åŠ æ“ä½œå¤šæ—¶ï¼Œæ•ˆç‡ä½ï¼Œå› ä¸ºæ¯æ¬¡æ·»åŠ æ—¶éƒ½ä¼šè¿›è¡Œå¤åˆ¶ï¼Œå¼€é”€éå¸¸çš„å¤§ã€‚</strong></p>
<ul>
<li><strong>æµ‹è¯•è¿­ä»£åŒºåˆ«</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCopyOnWriteArrayList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HelloThread ht = <span class="keyword">new</span> HelloThread();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(ht).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨è¿­ä»£å™¨</span></span><br><span class="line"><span class="comment"> * å› ä¸º è¿­ä»£å™¨ å’Œ list æ“ä½œçš„åŒä¸€ä¸ªæ•°æ®æº æ‰€ä»¥æ·»åŠ åä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment"> * Collections.synchronizedList(new ArrayList&lt;&gt;());</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//java.util.ConcurrentModificationException</span></span><br><span class="line">    <span class="comment">//private static List&lt;String&gt; list = Collections.synchronizedList(new ArrayList&lt;&gt;());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        list.add(<span class="string">"AA"</span>);</span><br><span class="line">        list.add(<span class="string">"BB"</span>);</span><br><span class="line">        list.add(<span class="string">"CC"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;String&gt; it = list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            System.out.println(it.next());</span><br><span class="line">            <span class="comment">//CopyOnWriteArrayList æ·»åŠ æ—¶éƒ½ä¼šåœ¨åº•å±‚å¤åˆ¶ä¸€ä»½æ–°çš„åˆ—è¡¨</span></span><br><span class="line">            list.add(<span class="string">"AA"</span>);</span><br><span class="line">            list.add(<span class="string">"A"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="42-unsafeset">4.2ã€UnSafeSet</h3>
<p><strong>CopyOnWriteArraySetï¼šåº•å±‚æ˜¯CopyOnWriteArrayList</strong></p>
<h4 id="hashset-æ•…éšœç°è±¡">HashSet æ•…éšœç°è±¡ğŸ‘‡</h4>
<ul>
<li><strong>java.util.ConcurrentModificationException</strong></li>
</ul>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnSafeHashSet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                set.add(UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">8</span>));</span><br><span class="line">                System.out.println(set.toString());</span><br><span class="line">            &#125;, String.valueOf(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="hashset-æ•…éšœå¯¼è‡´åŸå› ">HashSet æ•…éšœå¯¼è‡´åŸå› ğŸ‘‡</h4>
<ul>
<li><strong>å¹¶å‘äº‰æŠ¢ä¿®æ”¹å¯¼è‡´ã€‚</strong></li>
</ul>
<h4 id="hashset-æ•…éšœè§£å†³æ–¹æ¡ˆ">HashSet æ•…éšœè§£å†³æ–¹æ¡ˆğŸ‘‡</h4>
<ul>
<li><strong>Set<string> set = Collections.synchronizedSet(new HashSet&lt;&gt;());</string></strong></li>
<li><strong><code>Set&lt;String&gt; set = new CopyOnWriteArraySet&lt;&gt;();</code>æºç å¦‚ä¸‹</strong></li>
</ul>
<h2 id="äº”-é”-look">äº”ã€é” Look</h2>
<h3 id="é”çš„åˆ†ç±»">é”çš„åˆ†ç±»</h3>
<ul>
<li>
<p><strong>å…¬å¹³é”/éå…¬å¹³é”ï¼š</strong> å…¬å¹³é”æ˜¯æŒ‡å°½é‡ä»¥çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´å…ˆåé¡ºåºè·å–é”ï¼Œç­‰å¾…æ—¶é—´æœ€ä¹…çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ã€‚synchronized éšæ€§é”æ˜¯éå…¬å¹³é”ï¼Œå®ƒæ— æ³•ä¿è¯ç­‰å¾…çš„çº¿ç¨‹è·å–é”çš„é¡ºåºï¼ŒReentrantLookå¯ä»¥è‡ªå·±æ§åˆ¶æ˜¯å¦å…¬å¹³é”ã€‚</p>
</li>
<li>
<p><strong>å¯é‡å…¥é”ï¼š</strong> Synchronizedå’ŒReentrantLookéƒ½æ˜¯å¯é‡å…¥é”ï¼Œé”çš„å¯é‡å…¥æ€§æ ‡æ˜äº†é”æ˜¯é’ˆå¯¹çº¿ç¨‹åˆ†é…æ–¹å¼è€Œä¸æ˜¯é’ˆå¯¹æ–¹æ³•ã€‚ä¾‹å¦‚è°ƒç”¨Synchronizedæ–¹æ³•Aä¸­å¯ä»¥è°ƒç”¨Synchronizedæ–¹æ³•Bï¼Œè€Œä¸éœ€è¦é‡æ–°ç”³è¯·é”ã€‚</p>
</li>
<li>
<p><strong>è¯»å†™é”ï¼š</strong> æŒ‰ç…§æ•°æ®åº“äº‹åŠ¡éš”ç¦»ç‰¹æ€§çš„ç±»æ¯”è¯»å†™é”ï¼Œåœ¨è®¿é—®ç»Ÿä¸€ä¸ªèµ„æºï¼ˆä¸€ä¸ªæ–‡ä»¶ï¼‰çš„æ—¶å€™ï¼Œä½¿ç”¨è¯»é”æ¥ä¿è¯å¤šçº¿ç¨‹å¯ä»¥åŒæ­¥è¯»å–èµ„æºã€‚ReadWriteLockæ˜¯ä¸€ä¸ªè¯»å†™é”ï¼Œé€šè¿‡readLock()è·å–è¯»é”ï¼Œé€šè¿‡writeLock()è·å–å†™é”ã€‚</p>
</li>
<li>
<p><strong>å¯ä¸­æ–­é”ï¼š</strong> å¯ä¸­æ–­æ˜¯æŒ‡é”æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„ï¼ŒSynchronizedå†…ç½®é”æ˜¯ä¸å¯ä¸­æ–­é”ï¼ŒReentrantLockå¯ä»¥é€šè¿‡lockInterruptibly() æ–¹æ³•ä¸­æ–­æ˜¾æ€§é”ã€‚ä¾‹å¦‚çº¿ç¨‹Båœ¨ç­‰å¾…çº¿ç¨‹Aé‡Šæ”¾é”ï¼Œä½†æ˜¯çº¿ç¨‹Bç”±äºç­‰å¾…æ—¶é—´å¤ªä¹…ï¼Œå¯ä»¥ä¸»åŠ¨ä¸­æ–­ç­‰å¾…é”ã€‚</p>
</li>
</ul>
<h3 id="51-å…¬å¹³é”éå…¬å¹³é”">5.1ã€å…¬å¹³é”/éå…¬å¹³é”</h3>
<p><strong>å…¬å¹³é”ï¼š</strong> æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œå…ˆæ¥ååˆ° FIFOã€‚</p>
<ul>
<li><code>new ReentrantLock(true)</code></li>
</ul>
<p><strong>éå…¬å¹³é”ï¼š</strong>  æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ã€‚ä¼˜ç‚¹åœ¨äºé«˜å¹¶å‘æƒ…å†µä¸‹ååé‡æ¯”å…¬å¹³é”è¦å¤§ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆä¼˜å…ˆçº§åè½¬æˆ–è€…é¥¥é¥¿ç°è±¡ã€‚å½“çº¿ç¨‹å°è¯•å æœ‰é”å¤±è´¥ï¼Œå°±å†æ‰ç”¨ç±»ä¼¼å…¬å¹³é”é‚£ç§æ–¹å¼ã€‚</p>
<ul>
<li><code>synchronizedã€ReentrantLock(é»˜è®¤éå…¬å¹³)</code></li>
</ul>
<p><strong>ReentrantLock é»˜è®¤é‡‡ç”¨éå…¬å¹³é”ï¼Œé™¤éåœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥å‚æ•° true ï¼Œä¸ºå…¬å¹³é”ã€‚æºç å¦‚ä¸‹ï¼šğŸ‘‡</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Creates an instance of &#123;<span class="doctag">@code</span> ReentrantLock&#125;.</span></span><br><span class="line"><span class="comment">* This is equivalent to using &#123;<span class="doctag">@code</span> ReentrantLock(false)&#125;.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> fair &#123;<span class="doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="52-å¯é‡å…¥é”é€’å½’é”">5.2ã€å¯é‡å…¥é”(é€’å½’é”)</h3>
<p><strong>æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–è¯¥é”çš„ä»£ç ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—ã€‚</strong></p>
<p><strong><code>ä¼˜ç‚¹ï¼šé¿å…æ­»é”</code></strong></p>
<h4 id="synchronized">synchronized</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">inOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Come in One!"</span>);</span><br><span class="line">        inTwo();<span class="comment">// çº¿ç¨‹åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">inTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Come in Two!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            sync.inOne();</span><br><span class="line">        &#125;,<span class="string">"Thread-1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            sync.inOne();</span><br><span class="line">        &#125;,<span class="string">"Thread-2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">Thread-<span class="number">1</span> Come in One!</span><br><span class="line">Thread-<span class="number">1</span> Come in Two!</span><br><span class="line">Thread-<span class="number">2</span> Come in One!</span><br><span class="line">Thread-<span class="number">2</span> Come in Two!</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="reentrantlock">ReentrantLock</h4>
<ul>
<li><strong><code>åŠ é” lock</code> å’Œ <code>è§£é” unlock</code> éœ€è¦åŒ¹é… é…å¯¹ï¼Œå¯ä»¥ç¼–è¯‘ï¼Œä½†è¿è¡Œå‘ç”Ÿæ­»é”ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reetrant</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        inOne();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Come in One!"</span>);</span><br><span class="line">            inTwo();<span class="comment">// çº¿ç¨‹åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Come in Two!"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReetrantLockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Reetrant reetrant = <span class="keyword">new</span> Reetrant();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(reetrant, <span class="string">"Thread-3"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(reetrant, <span class="string">"Thread-4"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line">Thread-<span class="number">3</span> Come in One!</span><br><span class="line">Thread-<span class="number">3</span> Come in Two!</span><br><span class="line">Thread-<span class="number">4</span> Come in One!</span><br><span class="line">Thread-<span class="number">4</span> Come in Two!</span><br></pre></td></tr></table></figure>
<h4 id="synchronized-å’Œ-lock-åŒºåˆ«">synchronized å’Œ Lock åŒºåˆ«</h4>
<table>
<thead>
<tr>
<th style="text-align:center">å±‚æ¬¡</th>
<th style="text-align:center">Synchronized Javaå…³é”®å­—ï¼Œjvm å±‚é¢ä¸Š</th>
<th style="text-align:center">Lock æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒJava API å±‚</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">é”çŠ¶æ€</td>
<td style="text-align:center">æ— æ³•åˆ¤æ–­</td>
<td style="text-align:center">å¯ä»¥åˆ¤æ–­</td>
</tr>
<tr>
<td style="text-align:center">é”ç±»å‹</td>
<td style="text-align:center"><strong>éšå¼é”</strong>  å¯é‡å…¥ ä¸å¯ä¸­æ–­  éå…¬å¹³</td>
<td style="text-align:center"><strong>æ˜¾ç¤ºé”</strong> å¯é‡å…¥ å¯ä¸­æ–­ å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">æ€§èƒ½</td>
<td style="text-align:center">æ‚²è§‚é” é€‚ç”¨å°‘é‡åŒæ­¥</td>
<td style="text-align:center">ä¹è§‚é”ï¼ˆCASï¼‰ é€‚ç”¨å¤§é‡åŒæ­¥</td>
</tr>
<tr>
<td style="text-align:center">å”¤é†’</td>
<td style="text-align:center">éšæœºå”¤é†’ 1 ä¸ªæˆ– å”¤é†’å…¨éƒ¨çº¿ç¨‹ã€‚</td>
<td style="text-align:center">å¯ç²¾ç¡®å”¤é†’</td>
</tr>
</tbody>
</table>
<p><strong>1ã€åŸå§‹æ„æˆ</strong></p>
<ul>
<li>
<p><strong>synchronizedæ˜¯å…³é”®å­—å±äºJVMå±‚é¢ï¼Œåº•å±‚æ˜¯é€šè¿‡ <code>monitor</code> å¯¹è±¡æ¥å®Œæˆï¼Œå…¶å®wait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–<code>monitor</code> å¯¹è±¡åªæœ‰åœ¨åŒæ­¥ä»£ç å—å’ŒåŒæ­¥æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨wait/notifyç­‰æ–¹æ³•)</strong></p>
</li>
<li>
<p><strong>Lockæ˜¯å…·ä½“ç±» ( java.util.concurrent.locks.Lock )æ˜¯ API å±‚é¢çš„é”ã€‚</strong></p>
</li>
</ul>
<p><strong>2ã€é”çš„é‡Šæ”¾ï¼š</strong></p>
<ul>
<li><strong><code>Synchronized</code> åœ¨ä»£ç æ‰§è¡Œå®Œåæˆ–çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿå¼‚å¸¸æ­»é”ã€‚</strong></li>
<li><strong><code>Lock</code> å¼‚å¸¸æ—¶ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œéœ€è¦Lock() å’Œunlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆã€‚</strong></li>
</ul>
<p><strong>3ã€ç­‰å¾…æ˜¯å¦å¯ä¸­æ–­</strong></p>
<ul>
<li>
<p>synchronized ä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸æˆ–è€…æ­£å¸¸è¿è¡Œå®Œæˆã€‚</p>
</li>
<li>
<p>ReentrantLock å¯ä¸­æ–­ã€‚</p>
<ul>
<li>1.è®¾ç½®è¶…æ—¶æ–¹æ³•tryLock(long timeout, TimeUnit unit)</li>
<li>2.lockInterruptibly()æ”¾ä»£ç å—ä¸­ï¼Œè°ƒç”¨interrupt() æ–¹æ³•å¯ä¸­æ–­</li>
</ul>
</li>
</ul>
<p><strong>4ã€åŠ é”æ˜¯å¦å…¬å¹³</strong></p>
<ul>
<li>synchronized éå…¬å¹³é”ã€‚</li>
<li>Reentrantlock ä¸¤è€…éƒ½å¯ä»¥ï¼Œé»˜è®¤éå…¬å¹³é”ï¼Œæ„é€ æ–¹æ³•å¯ä»¥ä¼ å…¥booleanå€¼, true ä¸ºå…¬å¹³é”ï¼Œfalseä¸ºéå…¬å¹³é”ã€‚</li>
</ul>
<p><strong>5ã€é”ç»‘å®šå¤šä¸ªæ¡ä»¶condition</strong></p>
<ul>
<li>synchronized æ²¡æœ‰ã€‚</li>
<li>ReentrantLockç”¨æ¥å®ç°åˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ä»¬ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ï¼Œè€Œä¸æ˜¯åƒsynchronizedè¦ä¹ˆéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹è¦ä¹ˆå”¤é†’å…¨éƒ¨çº¿ç¨‹ã€‚</li>
</ul>
<p><strong>å¯¹synchronizedå’ŒReentrantLockè¿›è¡Œåæ±‡ç¼–</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">new</span> Object())&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: new           #2     // class java/lang/Object</span><br><span class="line">       <span class="number">3</span>: dup</span><br><span class="line">       4: invokespecial #1     // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">       <span class="number">7</span>: dup</span><br><span class="line">       <span class="number">8</span>: astore_1</span><br><span class="line">       <span class="number">9</span>: monitorenter</span><br><span class="line">      <span class="number">10</span>: aload_1</span><br><span class="line">      <span class="number">11</span>: monitorexit</span><br><span class="line">      <span class="number">12</span>: goto          <span class="number">20</span></span><br><span class="line">      <span class="number">15</span>: astore_2</span><br><span class="line">      <span class="number">16</span>: aload_1</span><br><span class="line">      <span class="number">17</span>: monitorexit</span><br><span class="line">      <span class="number">18</span>: aload_2</span><br><span class="line">      <span class="number">19</span>: athrow</span><br><span class="line">      20: new           #3    // class java/util/concurrent/locks/ReentrantLock</span><br><span class="line">      <span class="number">23</span>: dup</span><br><span class="line">      24: invokespecial #4    // Method java/util/concurrent/locks/ReentrantLock."&lt;init&gt;":()V</span><br><span class="line">      <span class="number">27</span>: pop</span><br><span class="line">      <span class="number">28</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>synchronized</code>æ˜ å°„æˆå­—èŠ‚ç æŒ‡ä»¤å°±æ˜¯ä¸¤ä¸ªæŒ‡ä»¤<code>monitorenter</code>å’Œ<code>monitorexit</code>ã€‚å½“ä¸€æ¡çº¿ç¨‹è¿›è¡Œæ‰§è¡Œçš„é‡åˆ°<code>monitorenter</code>æŒ‡ä»¤çš„æ—¶å€™ï¼Œå®ƒä¼šå»å°è¯•è·å¾—é”ï¼Œå¦‚æœè·å¾—é”é‚£ä¹ˆé”è®¡æ•°+1ï¼ˆä¸ºä»€ä¹ˆä¼šåŠ ä¸€å‘¢ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥é”ï¼Œæ‰€ä»¥éœ€è¦ç”¨è¿™ä¸ªé”è®¡æ•°åˆ¤æ–­é”çš„æƒ…å†µï¼‰ï¼Œå¦‚æœæ²¡æœ‰è·å¾—é”ï¼Œé‚£ä¹ˆé˜»å¡ã€‚å½“å®ƒé‡åˆ°<code>monitorexit</code>çš„æ—¶å€™ï¼Œé”è®¡æ•°å™¨-1ï¼Œå½“è®¡æ•°å™¨ä¸º0ï¼Œé‚£ä¹ˆå°±é‡Šæ”¾é”ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å‘ç°æœ‰2ä¸ª<code>monitorexit</code>ï¼Œsynchronizedé”é‡Šæ”¾æœ‰ä¸¤ç§æœºåˆ¶ï¼Œä¸€ç§å°±æ˜¯æ‰§è¡Œå®Œé‡Šæ”¾ï¼›å¦å¤–ä¸€ç§å°±æ˜¯å‘é€å¼‚å¸¸ï¼Œè™šæ‹Ÿæœºé‡Šæ”¾ã€‚ç¬¬äºŒä¸ª<code>monitorexit</code>å°±æ˜¯å‘ç”Ÿå¼‚å¸¸æ—¶æ‰§è¡Œçš„æµç¨‹ï¼Œåœ¨ç¬¬13è¡Œï¼Œæœ‰ä¸€ä¸ªgotoæŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ­£å¸¸è¿è¡Œç»“æŸä¼šè·³è½¬åˆ°20è¡Œæ‰§è¡Œã€‚</p>
<hr>
<h3 id="53-spinlock-è‡ªæ—‹é”-cas-æ€æƒ³">5.3ã€SpinLock è‡ªæ—‹é” ï¼ˆCAS æ€æƒ³ï¼‰</h3>
<p><strong>æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯æ¶ˆè€—CPUã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">" Lock!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!atomicReference.compareAndSet(<span class="keyword">null</span>, thread)) &#123;</span><br><span class="line">            System.out.println(thread.getName()+<span class="string">" CAS In"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unMyLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        atomicReference.compareAndSet(thread, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">" unLock!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpinLockTest spinLockTest = <span class="keyword">new</span> SpinLockTest();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            spinLockTest.myLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            spinLockTest.unMyLock();</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">"Thread-1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            spinLockTest.myLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            spinLockTest.unMyLock();</span><br><span class="line">        &#125;, <span class="string">"Thread-2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="54-readwritelockdemo-è¯»å†™é”">5.4ã€ReadWriteLockDemo è¯»å†™é”</h3>
<ul>
<li><strong>è¯»é”å…±äº«ã€å†™é”ç‹¬å ï¼šè¯»è¯»å…±å­˜ï¼Œè¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReadWriteLock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReadWriteLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ReadWriteLockDemo rw = <span class="keyword">new</span> ReadWriteLockDemo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> num = rw.set((<span class="keyword">int</span>) (Math.random() * <span class="number">101</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"-&gt;"</span> + num);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Write"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                rw.get();</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="comment">// è¯»</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.readLock().lock(); <span class="comment">// ä¸Šé”</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" : "</span> + number);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock().unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†™</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.number = number;</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="55-countdownlatch-é—­é”">5.5ã€CountDownLatch é—­é”</h3>
<p><strong>CountDownLatch ï¼šé—­é”ï¼Œè®©ä¸€äº›çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°å¦ä¸€äº›æ‰€æœ‰çº¿ç¨‹çš„è¿ç®—å…¨éƒ¨å®Œæˆï¼Œè®¡æ•°å™¨å€¼å˜ä¸º0æ—¶ï¼Œè°ƒç”¨await()è¢«é˜»å¡çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’ç»§ç»­è¿è¡Œã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCountDownLatch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line">        LatchDemo ld = <span class="keyword">new</span> LatchDemo(latch);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//10ä¸ªåˆ†çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(ld, <span class="string">"T"</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¸åŠ  latch.await();   10ä¸ªåˆ†çº¿ç¨‹å’Œ 1ä¸ªä¸»çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œæ²¡åŠæ³•è®¡ç®—æ—¶é—´</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();<span class="comment">//ä¸»çº¿ç¨‹</span></span><br><span class="line">        System.out.println(<span class="string">"è€—è´¹æ—¶é—´ä¸ºï¼š"</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LatchDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LatchDemo</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.latch = latch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æ¯ä¸ªçº¿ç¨‹éƒ½å„è‡ªæ‰“å°50ä»¥å†…çš„å¶æ•°</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">"----&gt;"</span> + i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="551-é—­é”æšä¸¾çš„ç”¨æ³•">5.5.1ã€é—­é”æšä¸¾çš„ç”¨æ³•</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO æšä¸¾çš„ç”¨æ³•</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName());</span><br><span class="line">                countDownLatch.countDown();<span class="comment">//TODO CountDownLatchåšå‡æ³•ï¼Œé”ä¸º 0ï¼Œé‡Šæ”¾ await</span></span><br><span class="line">            &#125;, enumDemo.foreach_enum(i).getStr()).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();<span class="comment">//TODO mainçº¿ç¨‹ç­‰å¾… ç›´åˆ° é‡Šæ”¾ await</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"-&gt;ç§¦ï¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> enumDemo &#123;</span><br><span class="line"></span><br><span class="line">    ONE(<span class="number">1</span>, <span class="string">"é½"</span>), TWO(<span class="number">2</span>, <span class="string">"æ¥š"</span>), THREE(<span class="number">3</span>, <span class="string">"ç‡•"</span>), FOUR(<span class="number">4</span>, <span class="string">"éŸ©"</span>), FIVE(<span class="number">5</span>, <span class="string">"èµµ"</span>), SIX(<span class="number">6</span>, <span class="string">"é­"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String str;</span><br><span class="line"></span><br><span class="line">    enumDemo(Integer code, String str) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> enumDemo <span class="title">foreach_enum</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        enumDemo[] values = enumDemo.values();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (enumDemo value : values) &#123;</span><br><span class="line">            <span class="keyword">if</span> (index == value.getCode()) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="56-cyclicbarrier-å¾ªç¯å±éšœ">5.6ã€CyclicBarrier å¾ªç¯å±éšœ</h3>
<ul>
<li><strong>ä¸ CountDownLatch ç›¸åï¼ŒåšåŠ æ³•ã€‚è®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœæ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šæ¿€æ´»ã€‚æ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚çº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡ await()æ–¹æ³•ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// public CyclicBarrier(int parties, Runnable barrierAction)</span></span><br><span class="line">        CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">7</span>, () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"å¬å”¤ç¥é¾™ï¼"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">7</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> num = i;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">"--&gt; æ”¶é›†åˆ°"</span> + num + <span class="string">"é¾™ç ï¼"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cyclicBarrier.await();<span class="comment">//TODO</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="56-semaphore-ä¿¡å·">5.6ã€semaphore ä¿¡å·</h3>
<ul>
<li><strong>ç”¨äºå…±äº«èµ„æºçš„äº’æ–¥ä½¿ç”¨ã€‚</strong></li>
<li><strong>å¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);<span class="comment">//æ¨¡æ‹Ÿ 3ä¸ªä½ç½®</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;<span class="comment">//æ¨¡æ‹Ÿ 6éƒ¨è½¦</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" æŠ¢åˆ°è½¦ä½ï¼"</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" åœè½¦3ç§’åç¦»å¼€è½¦ä½ï¼"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, String.valueOf(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="å…­-é˜»å¡é˜Ÿåˆ—-block-queue">å…­ã€é˜»å¡é˜Ÿåˆ— Block Queue</h2>
<h4 id="é˜»å¡é˜Ÿåˆ—æœ‰ä»€ä¹ˆå¥½å¤„">é˜»å¡é˜Ÿåˆ—æœ‰ä»€ä¹ˆå¥½å¤„</h4>
<p>åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤é†’ã€‚</p>
<ul>
<li>
<p><strong>ArrayBlockingQueue:ç”±æ•°ç‹™ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼›FIFO</strong></p>
</li>
<li>
<p><strong>LinkedBlockingQueue:ç”±é“¾è¡¨æ„ç‹™æˆçš„æœ‰ç•Œ(é»˜è®¤å¤§å° Integer.MAX _VALUE)é˜»å¡é˜Ÿåˆ—ï¼›FIFO</strong></p>
</li>
<li>
<p><strong>SynchronousQueue:ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³å˜ä¸ªå…ƒç´ çš„é˜Ÿåˆ—ï¼›</strong></p>
</li>
<li>
<p>PriorityBlockingQueue:æ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡åºåˆ—ï¼›</p>
</li>
<li>
<p>DelayQueue:ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡è‡¥åˆ—ï¼›</p>
</li>
<li>
<p>linkedTransferQueue:ç”±é“¾è¡¨ç»“æ„çµ„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼›</p>
</li>
<li>
<p>LinkedBlockingDeque:ç”±é“¾è¡¨ç»“æ„çµ„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</p>
</li>
</ul>
<p><strong>é˜»å¡é˜Ÿåˆ—æä¾›äº†å››ç§å¤„ç†æ–¹æ³•:</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•ç±»å‹</th>
<th>æŠ›å‡ºå¼‚å¸¸</th>
<th>ç‰¹æ®Šå€¼</th>
<th>é˜»å¡</th>
<th>è¶…æ—¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ’å…¥</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>ç§»é™¤</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>æ£€æŸ¥</td>
<td>element()</td>
<td>peek()</td>
<td>ä¸å¯ç”¨</td>
<td>ä¸å¯ç”¨</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>æŠ›å‡ºå¼‚å¸¸ï¼š</strong> æ˜¯æŒ‡å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶å€™ï¼Œå†å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡º IllegalStateException(â€œQueue fullâ€) å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ æ—¶ä¼šæŠ›å‡º NoSuchElementException å¼‚å¸¸ ã€‚</li>
<li><strong>è¿”å›ç‰¹æ®Šå€¼ï¼š</strong> æ’å…¥æ–¹æ³•ä¼šè¿”å›æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸåˆ™è¿”å› trueã€‚ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› null</li>
<li><strong>ä¸€ç›´é˜»å¡ï¼š</strong> å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ï¼Œæˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¹Ÿä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨ã€‚</li>
<li><strong>è¶…æ—¶é€€å‡ºï¼š</strong> å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚</li>
</ul>
<h4 id="çº¿ç¨‹é€šä¿¡ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…é˜»å¡é˜Ÿåˆ—">çº¿ç¨‹é€šä¿¡ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…é˜»å¡é˜Ÿåˆ—</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProdConsumer_BlockQueue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        MyResource myResource = <span class="keyword">new</span> MyResource(<span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">10</span>));</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tç”Ÿäº§çº¿ç¨‹å¯åŠ¨"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                myResource.myProd();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Prod"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tæ¶ˆè´¹çº¿ç¨‹å¯åŠ¨"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                myResource.myConsumer();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Consumer"</span>).start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"\t ä¸»çº¿ç¨‹å«åœFLAG=falseï¼Œç”Ÿäº§åŠ¨ä½œç»“æŸ"</span>);</span><br><span class="line">        myResource.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyResource</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> FLAG = <span class="keyword">true</span>;<span class="comment">//é»˜è®¤å¼€å¯ï¼Œè¿›è¡Œç”Ÿäº§+æ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    BlockingQueue&lt;String&gt; blockingQueue = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyResource</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.blockingQueue = blockingQueue;</span><br><span class="line">        System.out.println(blockingQueue.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myProd</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        String data;</span><br><span class="line">        <span class="keyword">boolean</span> retValue;</span><br><span class="line">        <span class="keyword">while</span>(FLAG)&#123;</span><br><span class="line">            data = atomicInteger.incrementAndGet() + <span class="string">""</span>;</span><br><span class="line">            retValue = blockingQueue.offer(data, <span class="number">2L</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span>(retValue)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"\t æ’å…¥é˜Ÿåˆ—"</span>+data+<span class="string">"æˆåŠŸ"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"\t æ’å…¥é˜Ÿåˆ—"</span>+data+<span class="string">"å¤±è´¥"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"/ FLAG = false,ç”Ÿäº§ç»“æŸ"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myConsumer</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        String result;</span><br><span class="line">        <span class="keyword">while</span>(FLAG)&#123;</span><br><span class="line">            result = blockingQueue.poll(<span class="number">2L</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == result || result.equalsIgnoreCase(<span class="string">""</span>))&#123;</span><br><span class="line">                FLAG = <span class="keyword">false</span>;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"\t è¶…è¿‡2ç§’æ²¡æœ‰æ¶ˆè´¹æˆåŠŸï¼Œæ¶ˆè´¹é€€å‡º"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"\tæ¶ˆè´¹é˜Ÿåˆ—"</span> + result + <span class="string">"æˆåŠŸ"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">        FLAG =<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¾“å‡º</span></span><br><span class="line">Prod	ç”Ÿäº§çº¿ç¨‹å¯åŠ¨</span><br><span class="line">Consumer	æ¶ˆè´¹çº¿ç¨‹å¯åŠ¨</span><br><span class="line">Prod	 æ’å…¥é˜Ÿåˆ—<span class="number">1</span>æˆåŠŸ</span><br><span class="line">Consumer	æ¶ˆè´¹é˜Ÿåˆ—<span class="number">1</span>æˆåŠŸ</span><br><span class="line">Consumer	æ¶ˆè´¹é˜Ÿåˆ—<span class="number">2</span>æˆåŠŸ</span><br><span class="line">Prod	 æ’å…¥é˜Ÿåˆ—<span class="number">2</span>æˆåŠŸ</span><br><span class="line">Consumer	æ¶ˆè´¹é˜Ÿåˆ—<span class="number">3</span>æˆåŠŸ</span><br><span class="line">Prod	 æ’å…¥é˜Ÿåˆ—<span class="number">3</span>æˆåŠŸ</span><br><span class="line">Prod	 æ’å…¥é˜Ÿåˆ—<span class="number">4</span>æˆåŠŸ</span><br><span class="line">Consumer	æ¶ˆè´¹é˜Ÿåˆ—<span class="number">4</span>æˆåŠŸ</span><br><span class="line">Prod	 æ’å…¥é˜Ÿåˆ—<span class="number">5</span>æˆåŠŸ</span><br><span class="line">Consumer	æ¶ˆè´¹é˜Ÿåˆ—<span class="number">5</span>æˆåŠŸ</span><br><span class="line">main	 ä¸»çº¿ç¨‹å«åœFLAG=<span class="keyword">false</span>ï¼Œç”Ÿäº§åŠ¨ä½œç»“æŸ</span><br><span class="line">Prod	 FLAG = <span class="keyword">false</span>,ç”Ÿäº§ç»“æŸ</span><br><span class="line">Consumer	 è¶…è¿‡<span class="number">2</span>ç§’æ²¡æœ‰æ¶ˆè´¹æˆåŠŸï¼Œæ¶ˆè´¹é€€å‡º</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="æ„Ÿè°¢é˜…è¯»">æ„Ÿè°¢é˜…è¯»</h1>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/article/é¢è¯•é—®é¢˜/" data-toggle="tooltip" data-placement="top" title="é¢è¯•é—®é¢˜æ€»ç»“">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/article/SpringBootæ ¸å¿ƒæŠ€æœ¯/" data-toggle="tooltip" data-placement="top" title="SpringBoot æ ¸å¿ƒæŠ€æœ¯">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--æ‰“èµ-->
                
                    <div class="reward">
                        <div class="reward-button">èµ <span class="reward-code"> 
                            <span class="alipay-code"> <img class="alipay-img" src="http://ww1.sinaimg.cn/large/006vWPzFly1g0o77ru34uj30dz0drdhv.jpg"><b>æ”¯ä»˜å®æ‰“èµ</b></span> 
                            <span class="wechat-code"> <img class="wechat-img" src="http://ww1.sinaimg.cn/large/006vWPzFly1g0o740lhb9j30rb0ov77z.jpg"><b>å¾®ä¿¡æ‰“èµ</b> </span>
                            </span></div>
                        <p class="reward-notice">èµèµä¸€ä¸‹</p>
                    </div>
                
                <!--æ‰“èµ-->

                <br>
                <!--åˆ†äº«-->
                
                <!--åˆ†äº«-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- å¤šè¯´ Share end-->

                <!-- å¤šè¯´è¯„è®ºæ¡† start -->
                
                <!-- å¤šè¯´è¯„è®ºæ¡† end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ä¸€-è¿›ç¨‹å’Œçº¿ç¨‹"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">&#x4E00;&#x3001;&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#11-å¤šè¿›ç¨‹ä¸å¤šçº¿ç¨‹åŒºåˆ«"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">1.1&#x3001;&#x591A;&#x8FDB;&#x7A0B;&#x4E0E;&#x591A;&#x7EBF;&#x7A0B;&#x533A;&#x522B;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#12-å®ˆæŠ¤çº¿ç¨‹ä¸éå®ˆæŠ¤çº¿ç¨‹"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">1.2&#x3001;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;&#x4E0E;&#x975E;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#å®ˆæŠ¤çº¿ç¨‹"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#éå®ˆæŠ¤çº¿ç¨‹ç”¨æˆ·çº¿ç¨‹"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">&#x975E;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;(&#x7528;&#x6237;&#x7EBF;&#x7A0B;)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">&#x521B;&#x5EFA;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B; &#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#åˆ›å»ºéå®ˆæŠ¤çº¿ç¨‹"><span class="toc-nav-number">1.2.4.</span> <span class="toc-nav-text">&#x521B;&#x5EFA;&#x975E;&#x5B88;&#x62A4;&#x7EBF;&#x7A0B;&#xFF1A;&#x1F447;</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#äºŒ-volatile"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">&#x4E8C;&#x3001;volatile</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#21-æµ‹è¯•-volatile-å†…å­˜å¯è§æ€§"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">2.1&#x3001;&#x6D4B;&#x8BD5; volatile &#x5185;&#x5B58;&#x53EF;&#x89C1;&#x6027;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#22-æµ‹è¯•-volatile-åŸå­æ€§"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">2.2&#x3001;&#x6D4B;&#x8BD5; volatile &#x539F;&#x5B50;&#x6027;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#23-cas"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">2.3&#x3001;CAS</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#unsafe-ç±»"><span class="toc-nav-number">2.3.1.</span> <span class="toc-nav-text">Unsafe &#x7C7B;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#cas-çš„ç¼ºç‚¹"><span class="toc-nav-number">2.3.2.</span> <span class="toc-nav-text">CAS &#x7684;&#x7F3A;&#x70B9;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#aba-é—®é¢˜"><span class="toc-nav-number">2.3.3.</span> <span class="toc-nav-text">ABA &#x95EE;&#x9898; &#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#è§£å†³-aba-åŸå­å¼•ç”¨"><span class="toc-nav-number">2.3.4.</span> <span class="toc-nav-text">&#x89E3;&#x51B3; ABA &#x539F;&#x5B50;&#x5F15;&#x7528;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#æ¨¡æ‹Ÿ-cas-ç®—æ³•"><span class="toc-nav-number">2.3.5.</span> <span class="toc-nav-text">&#x6A21;&#x62DF; CAS &#x7B97;&#x6CD5;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ä¸ºä»€ä¹ˆç”¨-cas-ä¸ç”¨-synchronized"><span class="toc-nav-number">2.3.6.</span> <span class="toc-nav-text">&#x4E3A;&#x4EC0;&#x4E48;&#x7528; CAS &#x4E0D;&#x7528; Synchronized</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#24-ç¦æ­¢æŒ‡ä»¤é‡æ’"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">2.4&#x3001;&#x7981;&#x6B62;&#x6307;&#x4EE4;&#x91CD;&#x6392;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#25-volatile-ä½¿ç”¨åœºæ™¯"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">2.5&#x3001;volatile &#x4F7F;&#x7528;&#x573A;&#x666F;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#å•ä¾‹è®¾è®¡æ¨¡å¼-dclåŒæ£€æŸ¥é”æœºåˆ¶"><span class="toc-nav-number">2.5.1.</span> <span class="toc-nav-text">&#x5355;&#x4F8B;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F; DCL&#x53CC;&#x68C0;&#x67E5;&#x9501;&#x673A;&#x5236;</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ä¸‰-concurrenthashmap"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">&#x4E09;&#x3001;ConcurrentHashMap</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#31-jdk-17-concurrenthashmap"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">3.1&#x3001;JDK 1.7 ConcurrentHashMap</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#32-jdk-18-concurrenthashmap"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">3.2&#x3001;JDK 1.8 ConcurrentHashMap</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#concurrenthashmap-çš„putæ–¹æ³•å®ç°"><span class="toc-nav-number">3.2.1.</span> <span class="toc-nav-text">ConcurrentHashMap &#x7684;put&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#concurrenthashmap-çš„getæ–¹æ³•å®ç°"><span class="toc-nav-number">3.2.2.</span> <span class="toc-nav-text">ConcurrentHashMap &#x7684;get&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#33-jdk18-synchronizedä»£æ›¿reentrantlock"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">3.3&#x3001;JDK1.8 Synchronized&#x4EE3;&#x66FF;ReentrantLock</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#å››-unsafecollection"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">&#x56DB;&#x3001;UnSafeCollection</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#41-unsafelist"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">4.1&#x3001;UnSafeList</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#arraylist-æ•…éšœç°è±¡"><span class="toc-nav-number">4.1.1.</span> <span class="toc-nav-text">ArrayList &#x6545;&#x969C;&#x73B0;&#x8C61;&#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#arraylist-æ•…éšœå¯¼è‡´åŸå› "><span class="toc-nav-number">4.1.2.</span> <span class="toc-nav-text">ArrayList &#x6545;&#x969C;&#x5BFC;&#x81F4;&#x539F;&#x56E0;&#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#arraylist-æ•…éšœè§£å†³æ–¹æ¡ˆ"><span class="toc-nav-number">4.1.3.</span> <span class="toc-nav-text">ArrayList &#x6545;&#x969C;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#copyonwritearraylist"><span class="toc-nav-number">4.1.4.</span> <span class="toc-nav-text">CopyOnWriteArrayList</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#42-unsafeset"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">4.2&#x3001;UnSafeSet</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#hashset-æ•…éšœç°è±¡"><span class="toc-nav-number">4.2.1.</span> <span class="toc-nav-text">HashSet &#x6545;&#x969C;&#x73B0;&#x8C61;&#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#hashset-æ•…éšœå¯¼è‡´åŸå› "><span class="toc-nav-number">4.2.2.</span> <span class="toc-nav-text">HashSet &#x6545;&#x969C;&#x5BFC;&#x81F4;&#x539F;&#x56E0;&#x1F447;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#hashset-æ•…éšœè§£å†³æ–¹æ¡ˆ"><span class="toc-nav-number">4.2.3.</span> <span class="toc-nav-text">HashSet &#x6545;&#x969C;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x1F447;</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#äº”-é”-look"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">&#x4E94;&#x3001;&#x9501; Look</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#é”çš„åˆ†ç±»"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">&#x9501;&#x7684;&#x5206;&#x7C7B;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#51-å…¬å¹³é”éå…¬å¹³é”"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">5.1&#x3001;&#x516C;&#x5E73;&#x9501;/&#x975E;&#x516C;&#x5E73;&#x9501;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#52-å¯é‡å…¥é”é€’å½’é”"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">5.2&#x3001;&#x53EF;&#x91CD;&#x5165;&#x9501;(&#x9012;&#x5F52;&#x9501;)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#synchronized"><span class="toc-nav-number">5.3.1.</span> <span class="toc-nav-text">synchronized</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#reentrantlock"><span class="toc-nav-number">5.3.2.</span> <span class="toc-nav-text">ReentrantLock</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#synchronized-å’Œ-lock-åŒºåˆ«"><span class="toc-nav-number">5.3.3.</span> <span class="toc-nav-text">synchronized &#x548C; Lock &#x533A;&#x522B;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#53-spinlock-è‡ªæ—‹é”-cas-æ€æƒ³"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">5.3&#x3001;SpinLock &#x81EA;&#x65CB;&#x9501; &#xFF08;CAS &#x601D;&#x60F3;&#xFF09;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#54-readwritelockdemo-è¯»å†™é”"><span class="toc-nav-number">5.5.</span> <span class="toc-nav-text">5.4&#x3001;ReadWriteLockDemo &#x8BFB;&#x5199;&#x9501;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#55-countdownlatch-é—­é”"><span class="toc-nav-number">5.6.</span> <span class="toc-nav-text">5.5&#x3001;CountDownLatch &#x95ED;&#x9501;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#551-é—­é”æšä¸¾çš„ç”¨æ³•"><span class="toc-nav-number">5.6.1.</span> <span class="toc-nav-text">5.5.1&#x3001;&#x95ED;&#x9501;&#x679A;&#x4E3E;&#x7684;&#x7528;&#x6CD5;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#56-cyclicbarrier-å¾ªç¯å±éšœ"><span class="toc-nav-number">5.7.</span> <span class="toc-nav-text">5.6&#x3001;CyclicBarrier &#x5FAA;&#x73AF;&#x5C4F;&#x969C;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#56-semaphore-ä¿¡å·"><span class="toc-nav-number">5.8.</span> <span class="toc-nav-text">5.6&#x3001;semaphore &#x4FE1;&#x53F7;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#å…­-é˜»å¡é˜Ÿåˆ—-block-queue"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">&#x516D;&#x3001;&#x963B;&#x585E;&#x961F;&#x5217; Block Queue</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#é˜»å¡é˜Ÿåˆ—æœ‰ä»€ä¹ˆå¥½å¤„"><span class="toc-nav-number">6.0.1.</span> <span class="toc-nav-text">&#x963B;&#x585E;&#x961F;&#x5217;&#x6709;&#x4EC0;&#x4E48;&#x597D;&#x5904;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#çº¿ç¨‹é€šä¿¡ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…é˜»å¡é˜Ÿåˆ—"><span class="toc-nav-number">6.0.2.</span> <span class="toc-nav-text">&#x7EBF;&#x7A0B;&#x901A;&#x4FE1;&#x4E4B;&#x751F;&#x4EA7;&#x8005;&#x6D88;&#x8D39;&#x8005;&#x963B;&#x585E;&#x961F;&#x5217;</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#æ„Ÿè°¢é˜…è¯»"><span class="toc-nav-number"></span> <span class="toc-nav-text">&#x611F;&#x8C22;&#x9605;&#x8BFB;</span></a>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#çº¿ç¨‹" title="çº¿ç¨‹">çº¿ç¨‹</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://yexua.github.io/" target="_blank">å¤§ä½¬</a></li>
                    
                        <li><a href="https://snailclimb.gitee.io/javaguide/#/" target="_blank">JavaGuide</a></li>
                    
                        <li><a href="http://cyc2018.gitee.io/cs-notes/#/notes/%E5%89%91%E6%8C%87%20Offer%20%E9%A2%98%E8%A7%A3%20-%20%E7%9B%AE%E5%BD%951" target="_blank">å‰‘æŒ‡Offer</a></li>
                    
                        <li><a href="http://cyc2018.gitee.io/cs-notes/#/" target="_blank">æŠ€æœ¯é¢è¯•å¿…å¤‡åŸºç¡€çŸ¥è¯†</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'â„¬'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/GitHub-yuteng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; äºè…¾ 2019 
                    <br>
                    Theme by <a href="http://beantech.org">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com">èƒ¡ä¼Ÿç…Œ</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://github-yuteng.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'xxx';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://github-yuteng.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
